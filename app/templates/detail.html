{% extends "base.html" %}

{% set page = "detail" %}

{% block body %}
<h1>Detail of Suite "{{ suite.id }}" üëç</h1>

<div id="notice"></div>

<form id="detail">
    <div class="form-group">
        <label for="data">Test Suite (File)</label>
        <textarea name="data" class="form-control">{{ suite.data }}</textarea>
    </div>
</form>

<div class="btn-group" role="group" aria-label="Button group with ...">
    <button type="button" class="btn btn-outline-primary btn-sm"
            form="detail" onclick="save(this.form);">
        Save
    </button>
    <button type="button" class="btn btn-outline-success btn-sm"
            form="detail" onclick="exec();">
        Execution
    </button>
    <div id=results class="btn-group" role="group">
        <button class="btn btn-outline-info btn-sm dropdown-toggle" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Results
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            {% for result in results %}
            <a class="dropdown-item" target="_blank"
               href="/{{suite.id}}/result/{{result.id}}">{{result.id}}</a>
            {% endfor %}
        </div>
    </div>
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-outline-danger btn-sm"
            data-toggle="modal" data-target="#delete-confirm">
        Delete
    </button>
</div>



<!-- Modal -->
<div class="modal fade" id="delete-confirm" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-body">
        Delete the Test Suite?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">
            Cancel
        </button>
        <button type="button" class="btn btn-primary btn-sm" onclick="del()">
            Yes, Delete It!
        </button>
      </div>
    </div>
  </div>
</div>


<script>
var id="{{suite.id}}", rev="{{suite.rev}}";

function notice(msg) {
    document.querySelector('#notice').insertAdjacentHTML('afterbegin', `
        <div class="alert alert-primary alert-dismissible fade show" role="alert">
            ${msg}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        `);
}

function save(form) {
    var xhr = new XMLHttpRequest();
    xhr.open("PUT", `/api/${id}`);
    xhr.setRequestHeader('Content-type','application/json');
    xhr.addEventListener("load", function() {
        // expect HTTP 204 NO Content
        ({id, rev, ok} = JSON.parse(this.responseText));
        notice(`Saved. Revision: ${rev}`);
    });
    xhr.send(JSON.stringify({'id': id, 'rev': rev, 'data': form.data.value}));
}

function exec() {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", `/api/${id}`);
    xhr.addEventListener("load", function() {
        notice(`DEBUG: ${this.status} - ${this.responseText}`);
    });
    xhr.send(null);
}

function del() {
    var xhr = new XMLHttpRequest();
    xhr.open("DELETE", `/api/${id}?rev=${rev}`);
    xhr.addEventListener("load", function() {
        notice(`DEBUG: ${this.status} - ${this.responseText}`);
        if (this.status == 200) {
            notice("Deleted! Redirect to list page after 3 seconds.");
            window.setTimeout(function() {
                window.location = "/";
            }, 3000);
        }
    });
    xhr.send(null);
}

// ref: https://stackoverflow.com/questions/37629860/automatically-resizing-textarea-in-bootstrap
document.querySelector('textarea').addEventListener('keydown', function() {
    this.style.overflow = 'hidden';
    this.style.paddingBottom = '25px';
    this.style.height = 0;
    this.style.height = this.scrollHeight + 'px';
    }, false);
document.querySelector('textarea').dispatchEvent(new Event('keydown'));
</script>
{% endblock %}
